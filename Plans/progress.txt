## Codebase Patterns
- OAuth: App.jsx → /auth → Shopify OAuth → /callback → stores token → redirects to UI
- Parameter Store: `/shopify/duxly-connection/shops/{appId}/{shop}/access-token`
- Frontend: React + Polaris UI + App Bridge CDN (embedded in Shopify Admin)
- Backend: Lambda functions in backend/functions/
- Stack name: `duxly-connection` (not ShopifyAppStack)
- **App Bridge CDN:** Use `window.shopify` directly, NOT `useAppBridge()` from npm package
- **Session tokens:** useSessionToken hook waits for App Bridge CDN to initialize before calling `shopify.idToken()`

---

## Completed Work (2026-01-09)

### Functionality Verified (Stories 100-104, 107-108, 111-112, 114-115)
- OAuth auto-authenticates on install, redirects to UI after callback
- GDPR webhooks with HMAC verification (gdpr.py - Python)
- TLS/SSL via AWS-managed certs (CloudFront + API Gateway)
- Session token auth implemented (verifySessionToken.js, useSessionToken.js hook)
- UI functional (Dashboard with stats, connection indicator)
- Uses Shopify Admin API with proper versioning (2024-01)
- No manual .myshopify.com URL entry required
- Modals only triggered by user interaction

### Compliance Verified (Stories 141, 150-163)
- App is a data connector (not lending/marketplace/payment/refund)
- Fully web-based, no desktop/browser extension
- Does not bypass checkout, theme store, or falsify data
- Original functionality, standard app submission

### Bug Fixed (Story 300)
- Added duxly-connection app credentials to Parameter Store
- Migrated shop credentials to correct path structure

---

## 2026-01-09 - Story 302 (Stats API Debug)
Thread: N/A (current session)

### What was implemented
- Fixed useSessionToken hook to work with App Bridge CDN approach
- The root cause: code was using `useAppBridge()` from `@shopify/app-bridge-react` npm package
- App Bridge CDN 4.x auto-initializes `window.shopify` which should be accessed directly
- Added `waitForAppBridge()` helper to handle async initialization race conditions
- Added `isReady` and `error` states for better error handling in consumers

### Files changed
- `frontend/src/hooks/useSessionToken.js`

### Learnings for future iterations
- **Critical:** When using App Bridge CDN (script tag in index.html), use `window.shopify` directly
- **DO NOT** use `useAppBridge()` hook from npm package - it's for bundled approach only
- The CDN auto-initialization may complete after React mounts, so always use async waiting
- Stats API endpoint `/stats` returns 401 without auth (expected) - Lambda IS working
- CloudWatch logs confirmed Lambda receives requests after fixing frontend

### Verification
- curl OPTIONS `/stats` → 200 (CORS preflight working)
- curl GET `/stats` → 401 "Missing or invalid Authorization header" (expected without token)
- CloudWatch logs show Lambda invocations
- Frontend rebuilt and deployed to S3
- CloudFront cache invalidated

---

## 2026-01-09 - Story 106 (App Bridge CDN)
Thread: N/A (current session)

### What was implemented
- Removed @shopify/app-bridge-react dependency from package.json
- Verified App Bridge loads from CDN (cdn.shopify.com/shopifycloud/app-bridge.js) via index.html script tag
- Verified no code imports from @shopify/app-bridge or @shopify/app-bridge-react

### Files changed
- `frontend/package.json` - removed @shopify/app-bridge-react dependency

### Verification
- `npm ls @shopify/app-bridge-react` returns empty (not installed)
- `grep -r "@shopify/app-bridge" frontend/src/` returns no matches
- Build succeeds without the dependency
- JS bundle size unchanged (package was never actually used)

---

## Active Issues

### Story 301 - Hart Beach Reinstall
- App credentials exist, but shop access token missing
- Requires merchant to reinstall to trigger OAuth
- No longer blocked by Story 302

---

## Remaining Work by Category

**Testing:** 109, 110, 113 (UI errors, reinstall flow)
**Partner Dashboard:** 105, 120-134 (listing requirements, icon, pricing)
**Legal/Docs:** 140, 142, 143 (connector forms)
**Custom Domain:** 200-207 (connections.duxly.eu setup)
