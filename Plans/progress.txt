## Codebase Patterns
- The stack was deployed with SAM (Serverless Application Model), not CDK bootstrap, so CDK deploy commands won't work directly
- Lambda functions use Python (auth.py, callback.py) not JavaScript despite JS files also being present in the deployment package
- The Python auth.py computes APP_URL dynamically from requestContext instead of using environment variable
- FRONTEND_URL is `https://d3hd7mj8z35qoh.cloudfront.net`
- API Gateway URL is `https://xehi9a6w6e.execute-api.eu-central-1.amazonaws.com/prod`
- Parameter Store prefix is `/shopify/duxly-connection`
- OAuth callback redirects to `https://admin.shopify.com/store/{shop}/apps/{api_key}` (Shopify embedded app pattern), not to FRONTEND_URL directly

---

## 2026-01-08 - Story 63
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- **What was verified:**
  - /auth endpoint returns HTTP 302 redirect to Shopify OAuth with:
    - Correct client_id: `5f284173d68eb2e02820df78902402a0`
    - Correct scopes: `read_products,write_products,read_orders`
    - Correct redirect_uri: `https://xehi9a6w6e.execute-api.eu-central-1.amazonaws.com/prod/callback`
    - State cookie set properly with HttpOnly, Secure, SameSite=Lax
  - /callback endpoint validation working correctly:
    - Returns 400 for missing required parameters (code, hmac, shop)
    - Returns 403 for invalid HMAC signature
    - Has proper environment variables configured (SHOPIFY_API_KEY, SHOPIFY_API_SECRET, PARAMETER_STORE_PREFIX, APP_URL, FRONTEND_URL)
  - Callback redirect goes to Shopify admin embedded app URL on success
  - CloudWatch logs show no errors - all invocations complete successfully (2ms avg)

- **Files changed:**
  - `/Users/timmatser/Dev/duxly-connection/Plans/prd.json` - Marked Story 63 as passes: true

- **Learnings for future iterations:**
  - OAuth callback correctly redirects to Shopify admin embedded app URL, not directly to FRONTEND_URL
  - HMAC verification requires all query params except `hmac` and `signature` sorted alphabetically
  - Lambda CloudWatch log group naming: `/aws/lambda/duxly-connection-{FunctionName}-{suffix}`
  - Use `aws logs filter-log-events --filter-pattern "ERROR"` to quickly find error logs

---

## 2026-01-08 - Story 62
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- **What was verified:**
  - S3 bucket `duxly-connection-frontendbucket-hxcfbg7bswep` contains:
    - `index.html` (405 bytes, last modified 2026-01-08 14:11:59)
    - `assets/index-BeiPL2RV.css` (444108 bytes)
    - `assets/index-j8T4wgll.js` (638497 bytes)
    - `assets/index-j8T4wgll.js.map` (1865435 bytes)
  - CloudFront distribution `d3hd7mj8z35qoh.cloudfront.net` returns HTTP 200
  - HTML content is valid and references correct asset paths (`/assets/index-*.js`, `/assets/index-*.css`)
  - JS and CSS assets are accessible via CloudFront (HTTP 200)
  - VITE_API_URL in built JS is correctly set to `https://xehi9a6w6e.execute-api.eu-central-1.amazonaws.com/prod`
  - Frontend `.env` file has correct VITE_API_URL and VITE_SHOPIFY_API_KEY

- **Files changed:**
  - `/Users/timmatser/Dev/duxly-connection/Plans/prd.json` - Marked Story 62 as passes: true

- **Learnings for future iterations:**
  - Frontend build outputs to `dist/` folder with hashed asset filenames
  - CloudFront caches content (X-Cache: Hit from cloudfront) - may need invalidation after deploy
  - Vite embeds environment variables at build time, not runtime

---

## 2026-01-08 - Story 61
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- **What was verified:**
  - CloudFormation stack `duxly-connection` exists with status `UPDATE_COMPLETE`
  - Stack outputs obtained:
    - ApiUrl: `https://xehi9a6w6e.execute-api.eu-central-1.amazonaws.com/prod`
    - FrontendUrl: `https://d3hd7mj8z35qoh.cloudfront.net`
    - FrontendBucketName: `duxly-connection-frontendbucket-hxcfbg7bswep`
    - Lambda ARNs for Auth, Callback, Proxy, Stats, GDPR functions
    - GDPR webhook URLs for customers_data_request, customers_redact, shop_redact
  - Lambda functions verified:
    - `duxly-connection-AuthFunction-hbP0byAjYLGe` (python3.12)
    - `duxly-connection-CallbackFunction-VAbLbFJmSWRZ` (python3.12)
    - `duxly-connection-ProxyFunction-kQaQRajiciA4` (python3.12)
    - `duxly-connection-StatsFunction-d7SIoegbePGJ` (nodejs20.x)
    - `duxly-connection-GdprFunction-I8gHYHmzOyag` (python3.12)
  - API Gateway endpoints verified: /auth, /callback, /stats, /proxy, /webhooks/gdpr/*
  - /auth endpoint tested - returns 302 redirect to Shopify OAuth with correct callback URL
  - CloudFront URL returns 200

- **Files changed:**
  - `/Users/timmatser/Dev/duxly-connection/Plans/prd.json` - Marked Story 61 as passes: true

- **Learnings for future iterations:**
  - StatsFunction is nodejs20.x, all others are python3.12
  - HEAD requests to API Gateway return 403 (MissingAuthenticationTokenException) - use GET
  - /stats returns 404 for non-existent shops which is expected valid behavior

---

## 2026-01-08 - Story 60
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- **What was implemented:**
  - Verified Lambda environment variables via AWS CLI
  - Updated root .env with correct APP_URL and FRONTEND_URL from CloudFormation outputs
  - Updated Lambda functions with APP_URL via `aws lambda update-function-configuration`
  - Fixed CDK stack to use dynamic API URL via `authFunction.addEnvironment('APP_URL', api.url)`
  - Removed duplicate OPTIONS method calls that conflicted with defaultCorsPreflightOptions
  - Updated CDK to use `parameterStorePrefix` variable consistently

- **Files changed:**
  - `/Users/timmatser/Dev/duxly-connection/.env` - Added APP_URL and FRONTEND_URL values
  - `/Users/timmatser/Dev/duxly-connection/infrastructure/lib/shopify-app-stack.ts` - Fixed environment variable handling

- **Learnings for future iterations:**
  - The deployed stack uses SAM, not CDK bootstrap - so `cdk deploy` fails with bootstrap error
  - Lambda uses Python runtime despite JS files in repo - check `Runtime` in function config
  - Python auth.py extracts APP_URL from requestContext, not environment variable
  - When testing Lambda directly via `aws lambda invoke`, requestContext is empty, so dynamic URL extraction fails
  - Test OAuth flow via actual API Gateway endpoint, not direct Lambda invocation
  - CloudFormation stack name is `duxly-connection`, API Gateway ID is `xehi9a6w6e`
  - Auth endpoint now correctly returns 302 redirect with proper callback URL

---
